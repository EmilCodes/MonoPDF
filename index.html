<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MonoPDF Magic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding-top: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .card {
      margin-bottom: 20px;
    }
    .progress {
      margin-top: 10px;
    }
  </style>
  <!-- Include pdf.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Include pdf-lib from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">MonoPDF Magic</h1>
    <div class="card">
      <div class="card-body">
        <p>Select one or more PDF files to convert them to black &amp; white:</p>
        <input type="file" id="fileInput" accept="application/pdf" multiple class="form-control">
        <button id="convertBtn" class="btn btn-primary mt-3">Convert PDFs</button>
      </div>
    </div>
    <div id="output"></div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const convertBtn = document.getElementById("convertBtn");
    const outputDiv = document.getElementById("output");

    // Function to convert canvas image data to black and white using thresholding
    function convertCanvasToBW(canvas, threshold = 200) {
      const ctx = canvas.getContext("2d");
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        // Convert to grayscale
        const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        // Apply threshold
        const bw = avg < threshold ? 0 : 255;
        data[i] = data[i + 1] = data[i + 2] = bw;
      }
      ctx.putImageData(imgData, 0, 0);
      return canvas;
    }

    // Process a single PDF file and return its new PDF bytes
    async function processSinglePDF(arrayBuffer) {
      // Load PDF with pdf.js
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      const numPages = pdf.numPages;
      const processedPages = [];

      // Loop over pages
      for (let pageNum = 1; pageNum <= numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const scale = 2;
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext("2d");

        await page.render({ canvasContext: ctx, viewport }).promise;
        convertCanvasToBW(canvas);
        const dataUrl = canvas.toDataURL("image/png");
        processedPages.push({ dataUrl, width: canvas.width, height: canvas.height });
      }

      // Create new PDF using pdf-lib
      const pdfDoc = await PDFLib.PDFDocument.create();
      for (const pageData of processedPages) {
        const pngImageBytes = await fetch(pageData.dataUrl).then((res) => res.arrayBuffer());
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        const page = pdfDoc.addPage([pageData.width, pageData.height]);
        page.drawImage(pngImage, {
          x: 0,
          y: 0,
          width: pageData.width,
          height: pageData.height,
        });
      }

      const pdfBytes = await pdfDoc.save();
      return pdfBytes;
    }

    // Process all selected PDF files
    async function processPDFs(files) {
      outputDiv.innerHTML = "";
      for (const file of files) {
        // Create a card for each file to show its progress and download link
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${file.name}</h5>
            <p class="card-text" id="status-${file.name}">Processing...</p>
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
              style="width: 100%"></div>
            </div>
          </div>
        `;
        outputDiv.appendChild(card);

        try {
          const arrayBuffer = await file.arrayBuffer();
          const newPdfBytes = await processSinglePDF(arrayBuffer);
          const blob = new Blob([newPdfBytes], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);
          card.querySelector(`#status-${file.name}`).innerHTML = `<a href="${url}" download="${file.name.replace('.pdf','')}-converted.pdf">Download Converted PDF</a>`;
        } catch (e) {
          console.error(e);
          card.querySelector(`#status-${file.name}`).textContent = "Error processing this PDF.";
        }
      }
    }

    convertBtn.addEventListener("click", async () => {
      if (!fileInput.files.length) {
        alert("Please select at least one PDF file.");
        return;
      }
      await processPDFs(fileInput.files);
    });
  </script>
  <!-- Bootstrap JS Bundle with Popper (Optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
