<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MonoPDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding-top: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .card {
      margin-bottom: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    .progress {
      margin-top: 10px;
    }

    /* Dark Mode Styling */
    .dark-mode {
      background-color: #121212 !important;
      color: #f4f4f4 !important;
    }
    .dark-mode .card {
      background-color: #1e1e1e;
      color: #f4f4f4;
    }
    .dark-mode .btn {
      background-color: #333 !important;
      color: #fff !important;
      border-color: #555 !important;
    }
    .dark-mode .progress {
      background-color: #333;
    }
    .dark-mode .progress-bar {
      background-color: #666 !important;
    }
  </style>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Header with Dark Mode Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="m-0">MonoPDF</h1>
      <button id="darkModeBtn" class="btn btn-secondary">
        <span id="themeText">Dark Mode</span>
      </button>
    </div>
    
    <div class="card">
      <div class="card-body">
        <p>Select one or more PDF files to convert them to black &amp; white:</p>
        <input type="file" id="fileInput" accept="application/pdf" multiple class="form-control">
        <button id="convertBtn" class="btn btn-primary mt-3">Convert PDFs</button>
      </div>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const convertBtn = document.getElementById("convertBtn");
    const outputDiv = document.getElementById("output");
    const darkModeBtn = document.getElementById("darkModeBtn");
    const themeText = document.getElementById("themeText");

    // --- DARK MODE SETUP ---
    // Check localStorage for userâ€™s dark mode preference
    const userPrefersDark = localStorage.getItem("darkMode") === "enabled";
    applyDarkMode(userPrefersDark);

    // Toggle dark mode on button click
    darkModeBtn.addEventListener("click", () => {
      const isDarkNow = document.body.classList.contains("dark-mode");
      applyDarkMode(!isDarkNow);
    });

    // Apply or remove dark mode, save preference
    function applyDarkMode(enable) {
      if (enable) {
        document.body.classList.add("dark-mode");
        localStorage.setItem("darkMode", "enabled");
        themeText.textContent = "Light Mode";
      } else {
        document.body.classList.remove("dark-mode");
        localStorage.setItem("darkMode", "disabled");
        themeText.textContent = "Dark Mode";
      }
    }

    // --- PDF CONVERSION LOGIC ---
    // Convert canvas image data to black & white
    function convertCanvasToBW(canvas, threshold = 200) {
      const ctx = canvas.getContext("2d");
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        // Convert pixel to grayscale
        const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        const bw = avg < threshold ? 0 : 255;
        data[i] = data[i + 1] = data[i + 2] = bw;
      }
      ctx.putImageData(imgData, 0, 0);
      return canvas;
    }

    // Process a single PDF -> returns new PDF bytes
    async function processSinglePDF(arrayBuffer) {
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      const numPages = pdf.numPages;
      const processedPages = [];

      for (let pageNum = 1; pageNum <= numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const scale = 2;
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext("2d");

        await page.render({ canvasContext: ctx, viewport }).promise;
        convertCanvasToBW(canvas);

        const dataUrl = canvas.toDataURL("image/png");
        processedPages.push({ dataUrl, width: canvas.width, height: canvas.height });
      }

      // Build a new PDF with pdf-lib
      const pdfDoc = await PDFLib.PDFDocument.create();
      for (const pageData of processedPages) {
        const pngImageBytes = await fetch(pageData.dataUrl).then(res => res.arrayBuffer());
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        const page = pdfDoc.addPage([pageData.width, pageData.height]);
        page.drawImage(pngImage, {
          x: 0,
          y: 0,
          width: pageData.width,
          height: pageData.height,
        });
      }

      return await pdfDoc.save();
    }

    // Process all selected PDFs
    async function processPDFs(files) {
      outputDiv.innerHTML = "";
      let fileCounter = 0;
      for (const file of files) {
        // Create a unique ID for progress bar
        const safeId = "file-" + fileCounter++;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${file.name}</h5>
            <p class="card-text" id="status-${safeId}">Processing...</p>
            <div class="progress">
              <div id="progress-bar-${safeId}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
          </div>
        `;
        outputDiv.appendChild(card);

        try {
          const arrayBuffer = await file.arrayBuffer();
          const newPdfBytes = await processSinglePDF(arrayBuffer);
          const blob = new Blob([newPdfBytes], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);

          // Update the card
          document.getElementById("status-" + safeId).innerHTML = `
            <a href="${url}" download="${file.name.replace('.pdf','')}-converted.pdf">
              Download Converted PDF
            </a>
          `;
        } catch (e) {
          console.error(e);
          document.getElementById("status-" + safeId).textContent = "Error processing this PDF.";
        } finally {
          // Remove the animated progress bar effect
          const progressBar = document.getElementById(`progress-bar-${safeId}`);
          progressBar.classList.remove("progress-bar-striped", "progress-bar-animated");
        }
      }
    }

    // Button click -> process
    convertBtn.addEventListener("click", async () => {
      if (!fileInput.files.length) {
        alert("Please select at least one PDF file.");
        return;
      }
      await processPDFs(fileInput.files);
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
